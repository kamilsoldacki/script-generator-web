<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VA Script Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-row">
                <div class="header-left">
                    <div class="header-title">IIElevenLabs</div>
                </div>
                {% if auth_enabled %}
                    <a class="header-link" href="/logout">Log out</a>
                {% endif %}
            </div>
        </header>

        <div class="card">
            <p class="card-subtitle">Keep it simple. Generate a VA script and download it as a .txt.</p>
            <form id="scriptForm">
                <div class="form-group">
                    <label for="script_type">Script type</label>
                    <input
                        id="script_type"
                        name="script_type"
                        type="text"
                        required
                        placeholder="e.g., agent, conversational, explainer, product demo, training"
                    />
                </div>

                <div class="form-group">
                    <label for="language">Language</label>
                    <select id="language" name="language" required>
                        <option value="AFR">AFR — Afrikaans</option>
                        <option value="ARA">ARA — Arabic</option>
                        <option value="HYE">HYE — Armenian</option>
                        <option value="ASM">ASM — Assamese</option>
                        <option value="AZE">AZE — Azerbaijani</option>
                        <option value="BEL">BEL — Belarusian</option>
                        <option value="BEN">BEN — Bengali</option>
                        <option value="BOS">BOS — Bosnian</option>
                        <option value="BUL">BUL — Bulgarian</option>
                        <option value="CAT">CAT — Catalan</option>
                        <option value="CEB">CEB — Cebuano</option>
                        <option value="NYA">NYA — Chichewa</option>
                        <option value="HRV">HRV — Croatian</option>
                        <option value="CES">CES — Czech</option>
                        <option value="DAN">DAN — Danish</option>
                        <option value="NLD">NLD — Dutch</option>
                        <option value="ENG" selected>ENG — English</option>
                        <option value="EST">EST — Estonian</option>
                        <option value="FIL">FIL — Filipino</option>
                        <option value="FIN">FIN — Finnish</option>
                        <option value="FRA">FRA — French</option>
                        <option value="GLG">GLG — Galician</option>
                        <option value="KAT">KAT — Georgian</option>
                        <option value="DEU">DEU — German</option>
                        <option value="ELL">ELL — Greek</option>
                        <option value="GUJ">GUJ — Gujarati</option>
                        <option value="HAU">HAU — Hausa</option>
                        <option value="HEB">HEB — Hebrew</option>
                        <option value="HIN">HIN — Hindi</option>
                        <option value="HUN">HUN — Hungarian</option>
                        <option value="ISL">ISL — Icelandic</option>
                        <option value="IND">IND — Indonesian</option>
                        <option value="GLE">GLE — Irish</option>
                        <option value="ITA">ITA — Italian</option>
                        <option value="JPN">JPN — Japanese</option>
                        <option value="JAV">JAV — Javanese</option>
                        <option value="KAN">KAN — Kannada</option>
                        <option value="KAZ">KAZ — Kazakh</option>
                        <option value="KIR">KIR — Kirghiz</option>
                        <option value="KOR">KOR — Korean</option>
                        <option value="LAV">LAV — Latvian</option>
                        <option value="LIN">LIN — Lingala</option>
                        <option value="LIT">LIT — Lithuanian</option>
                        <option value="LTZ">LTZ — Luxembourgish</option>
                        <option value="MKD">MKD — Macedonian</option>
                        <option value="MSA">MSA — Malay</option>
                        <option value="MAL">MAL — Malayalam</option>
                        <option value="CMN">CMN — Mandarin Chinese</option>
                        <option value="MAR">MAR — Marathi</option>
                        <option value="NEP">NEP — Nepali</option>
                        <option value="NOR">NOR — Norwegian</option>
                        <option value="PUS">PUS — Pashto</option>
                        <option value="FAS">FAS — Persian</option>
                        <option value="POL">POL — Polish</option>
                        <option value="POR">POR — Portuguese</option>
                        <option value="PAN">PAN — Punjabi</option>
                        <option value="RON">RON — Romanian</option>
                        <option value="RUS">RUS — Russian</option>
                        <option value="SRP">SRP — Serbian</option>
                        <option value="SND">SND — Sindhi</option>
                        <option value="SLK">SLK — Slovak</option>
                        <option value="SLV">SLV — Slovenian</option>
                        <option value="SOM">SOM — Somali</option>
                        <option value="SPA">SPA — Spanish</option>
                        <option value="SWA">SWA — Swahili</option>
                        <option value="SWE">SWE — Swedish</option>
                        <option value="TAM">TAM — Tamil</option>
                        <option value="TEL">TEL — Telugu</option>
                        <option value="THA">THA — Thai</option>
                        <option value="TUR">TUR — Turkish</option>
                        <option value="UKR">UKR — Ukrainian</option>
                        <option value="URD">URD — Urdu</option>
                        <option value="VIE">VIE — Vietnamese</option>
                        <option value="CYM">CYM — Welsh</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="accent">Accent / dialect (optional)</label>
                    <input id="accent" name="accent" type="text" placeholder="e.g., neutral, en-GB, South African English..." />
                </div>

                <div class="form-group">
                    <label for="details">Details (optional)</label>
                    <textarea
                        id="details"
                        name="details"
                        rows="8"
                        placeholder="Describe the situation (not just a topic). Include who is speaking and to whom, the goal, the setting/context, tone, and 3–6 must-have points. For support/call center: describe the customer issue (what happened, error/symptoms, what was tried, desired outcome) — otherwise it may turn into “news”-style narration."
                    ></textarea>
                </div>

                <div class="form-group">
                    <label for="brief">Brief (optional)</label>
                    <textarea 
                        id="brief" 
                        name="brief" 
                        rows="6"
                        placeholder="Optional: 1–3 sentences to lock the format and rules (conversational vs narration, character voice, pacing, do/don’t). You can also specify punctuation/normalization rules (e.g., remove dashes, short sentences), and number style (spell out numbers vs digits). Example (support/call center): agent-only lines, no labels, no customer lines, not news; structure: greet → verify → diagnose → steps → recap → close."
                    ></textarea>
                </div>

                <div class="form-group">
                    <label for="target_minutes">Target length (minutes)</label>
                    <input id="target_minutes" name="target_minutes" type="number" min="1" max="60" step="1" value="5" required />
                    <div class="hint" id="targetWordsHint"></div>
                    <label class="checkbox-row">
                        <input id="v3" name="v3" type="checkbox" />
                        v3 (add voice audio tags like [sighs])
                    </label>
                </div>

                <button type="submit" class="btn-primary" id="generateBtn">
                    Generate
                </button>
            </form>
        </div>

        <div id="resultSection" class="card result-section" style="display: none;">
            <h2>Script ready</h2>
            <div class="meta-row">
                <div class="meta-item" id="estimatedLength"></div>
                <div class="meta-item" id="wordCount"></div>
            </div>
            
            <div class="preview-box">
                <h3>Preview</h3>
                <div id="preview"></div>
            </div>

            <div class="action-buttons">
                <button id="downloadBtn" class="btn-success">
                    Download .txt
                </button>
                <button id="downloadMetaBtn" class="btn-secondary" style="width:100%;">
                    Download metadata (.json)
                </button>
                <button id="downloadOutlineBtn" class="btn-secondary" style="width:100%; display:none;">
                    Download outline (.json)
                </button>
                <button id="newScriptBtn" class="btn-secondary">
                    New script
                </button>
            </div>
        </div>

        <div id="loadingSection" class="loading-section" style="display: none;">
            <div class="spinner"></div>
            <p>Generating...</p>
            <div class="progress-wrap" aria-label="Estimated progress">
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-meta">
                    <span id="progressPct">0%</span>
                    <span id="progressEta">Usually a few minutes.</span>
                </div>
            </div>
            <p class="loading-subtext">Usually takes a few minutes. You can do something else — this page will reload when the script is ready.</p>
        </div>

        <div id="errorSection" class="error-section" style="display: none;">
            <div class="error-box">
                <h3>Error</h3>
                <p id="errorMessage"></p>
                <button id="retryBtn" class="btn-secondary">Try again</button>
            </div>
        </div>
    </div>

    <footer>
        <p>Built with ❤️ for the ElevenLabs team · Kamil Soldacki</p>
    </footer>

    <script>
        let currentTxtUrl = null;
        let currentMetaUrl = null;
        let currentOutlineUrl = null;

        const form = document.getElementById('scriptForm');
        const resultSection = document.getElementById('resultSection');
        const loadingSection = document.getElementById('loadingSection');
        const errorSection = document.getElementById('errorSection');
        const targetMinutesInput = document.getElementById('target_minutes');
        const targetWordsHint = document.getElementById('targetWordsHint');
        const progressFill = document.getElementById('progressFill');
        const progressPct = document.getElementById('progressPct');
        const progressEta = document.getElementById('progressEta');

        const LAST_RESULT_KEY = 'sg_last_result_v1';
        const CURRENT_JOB_KEY = 'sg_current_job_v1';

        let pollTimer = null;

        function stopPolling() {
            if (pollTimer) clearTimeout(pollTimer);
            pollTimer = null;
        }

        function showResultFromData(data) {
            currentTxtUrl = data.txt_url || null;
            currentMetaUrl = data.meta_url || null;
            currentOutlineUrl = data.outline_url || null;
            document.getElementById('preview').textContent = data.preview;
            document.getElementById('estimatedLength').textContent = data.estimated_minutes ? `Estimated length: ~${data.estimated_minutes} min` : '';
            document.getElementById('wordCount').textContent = data.word_count ? `Words: ${data.word_count}` : '';

            const outlineBtn = document.getElementById('downloadOutlineBtn');
            if (outlineBtn) {
                outlineBtn.style.display = currentOutlineUrl ? 'block' : 'none';
            }

            form.parentElement.style.display = 'none';
            loadingSection.style.display = 'none';
            errorSection.style.display = 'none';
            resultSection.style.display = 'block';
        }

        // If we reloaded after finishing, restore the last result.
        const last = localStorage.getItem(LAST_RESULT_KEY);
        if (last) {
            try {
                const data = JSON.parse(last);
                localStorage.removeItem(LAST_RESULT_KEY);
                if (data && data.success && data.txt_url) {
                    showResultFromData(data);
                }
            } catch (e) {
                localStorage.removeItem(LAST_RESULT_KEY);
            }
        }

        async function pollJob(jobId, attempt = 0) {
            stopPolling();
            try {
                const res = await fetch(`/jobs/${jobId}`);
                const payload = await res.json();

                if (!res.ok) {
                    throw new Error(payload.error || 'Job failed.');
                }

                const pct = Math.max(0, Math.min(100, parseInt(payload.progress || 0, 10)));
                if (progressFill) progressFill.style.width = `${pct}%`;
                if (progressPct) progressPct.textContent = `${pct}%`;
                if (progressEta) progressEta.textContent = payload.message || payload.stage || 'Working…';

                if ((payload.status === 'finished' || payload.stage === 'done') && payload.result && payload.result.success) {
                    if (progressFill) progressFill.style.width = '100%';
                    if (progressPct) progressPct.textContent = '100%';
                    if (progressEta) progressEta.textContent = 'Done. Reloading...';
                    localStorage.removeItem(CURRENT_JOB_KEY);
                    localStorage.setItem(LAST_RESULT_KEY, JSON.stringify(payload.result));
                    setTimeout(() => window.location.reload(), 600);
                    return;
                }

                // continue polling with gentle backoff
                const nextDelay = Math.min(4000, 800 + attempt * 120);
                pollTimer = setTimeout(() => pollJob(jobId, attempt + 1), nextDelay);
            } catch (err) {
                stopPolling();
                localStorage.removeItem(CURRENT_JOB_KEY);
                document.getElementById('errorMessage').textContent = err && err.message ? err.message : 'Unknown error';
                loadingSection.style.display = 'none';
                errorSection.style.display = 'block';
            }
        }

        // If a job is in progress and the user refreshed, resume polling.
        const existingJob = localStorage.getItem(CURRENT_JOB_KEY);
        if (existingJob && !last) {
            form.parentElement.style.display = 'none';
            resultSection.style.display = 'none';
            errorSection.style.display = 'none';
            loadingSection.style.display = 'block';
            if (progressFill) progressFill.style.width = '0%';
            if (progressPct) progressPct.textContent = '0%';
            if (progressEta) progressEta.textContent = 'Resuming…';
            pollJob(existingJob);
        }

        function updateTargetWordsHint() {
            const minutes = parseInt(targetMinutesInput.value || '0', 10);
            if (!minutes || minutes < 1) {
                targetWordsHint.textContent = '';
                return;
            }
            const approxWords = Math.round(minutes * 150);
            targetWordsHint.textContent = `We will aim for about ${approxWords} words.`;
        }
        targetMinutesInput.addEventListener('input', updateTargetWordsHint);
        updateTargetWordsHint();

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const scriptTypeEl = document.getElementById('script_type');
            const script_type = scriptTypeEl.value;
            const language = document.getElementById('language').value;
            const accent = document.getElementById('accent').value;
            const details = document.getElementById('details').value;
            const brief = document.getElementById('brief').value;
            const target_minutes = parseInt(document.getElementById('target_minutes').value, 10);
            const v3 = !!document.getElementById('v3')?.checked;

            if (!script_type || !script_type.trim()) {
                document.getElementById('errorMessage').textContent = 'Please enter Script type.';
                loadingSection.style.display = 'none';
                resultSection.style.display = 'none';
                errorSection.style.display = 'block';
                scriptTypeEl.focus();
                return;
            }

            // Show loading
            form.parentElement.style.display = 'none';
            resultSection.style.display = 'none';
            errorSection.style.display = 'none';
            loadingSection.style.display = 'block';
            if (progressFill) progressFill.style.width = '0%';
            if (progressPct) progressPct.textContent = '0%';
            if (progressEta) progressEta.textContent = 'Queued…';

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        script_type,
                        language,
                        accent,
                        details,
                        brief,
                        target_minutes,
                        v3,
                    })
                });

                const rawText = await response.text();
                let data = null;
                try {
                    data = rawText ? JSON.parse(rawText) : {};
                } catch (e) {
                    const snippet = rawText ? rawText.slice(0, 240) : '';
                    throw new Error(`Non-JSON response (${response.status}). ${snippet}`);
                }

                if (response.ok && data.success) {
                    const jobId = data.job_id;
                    if (!jobId) throw new Error('Missing job_id from server.');
                    localStorage.setItem(CURRENT_JOB_KEY, jobId);
                    pollJob(jobId);
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                stopPolling();
                console.error('Error:', error);
                document.getElementById('errorMessage').textContent = error.message;
                loadingSection.style.display = 'none';
                errorSection.style.display = 'block';
            }
        });

        // Download button
        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (currentTxtUrl) {
                window.location.href = currentTxtUrl;
            }
        });

        // Download meta button
        document.getElementById('downloadMetaBtn').addEventListener('click', () => {
            if (currentMetaUrl) {
                window.location.href = currentMetaUrl;
            }
        });

        // Download outline button
        document.getElementById('downloadOutlineBtn').addEventListener('click', () => {
            if (currentOutlineUrl) {
                window.location.href = currentOutlineUrl;
            }
        });

        // New script button
        document.getElementById('newScriptBtn').addEventListener('click', () => {
            resultSection.style.display = 'none';
            form.parentElement.style.display = 'block';
            form.reset();
            updateTargetWordsHint();
            localStorage.removeItem(LAST_RESULT_KEY);
            localStorage.removeItem(CURRENT_JOB_KEY);
            stopPolling();
        });

        // Retry button
        document.getElementById('retryBtn').addEventListener('click', () => {
            errorSection.style.display = 'none';
            form.parentElement.style.display = 'block';
            localStorage.removeItem(CURRENT_JOB_KEY);
            stopPolling();
        });
    </script>
</body>
</html>


