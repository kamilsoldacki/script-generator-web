<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-row">
                <div class="header-left">
                    <div class="header-title">Script Generator</div>
                    <div class="header-subtitle">Generate a voiceover script and download it as a .txt file.</div>
                </div>
                {% if auth_enabled %}
                    <a class="header-link" href="/logout">Log out</a>
                {% endif %}
            </div>
        </header>

        <div class="card">
            <h1>Generate a script</h1>
            <p class="card-subtitle">Keep it simple. One voice only.</p>
            <form id="scriptForm">
                <div class="form-group">
                    <label for="script_type">Script type</label>
                    <input
                        id="script_type"
                        name="script_type"
                        type="text"
                        required
                        placeholder="e.g., agent, conversational, explainer, product demo, training"
                    />
                </div>

                <div class="form-group">
                    <label for="language">Language</label>
                    <select id="language" name="language" required>
                        <option value="English (en-US)" selected>English (en-US)</option>
                        <option value="English (en-GB)">English (en-GB)</option>
                        <option value="Polish (pl-PL)">Polish (pl-PL)</option>
                        <option value="Español (es-ES)">Spanish (es-ES)</option>
                        <option value="Français (fr-FR)">French (fr-FR)</option>
                        <option value="Deutsch (de-DE)">German (de-DE)</option>
                        <option value="Italiano (it-IT)">Italian (it-IT)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="accent">Accent / dialect (optional)</label>
                    <input id="accent" name="accent" type="text" placeholder="e.g., neutral, en-GB, South African English..." />
                </div>

                <div class="form-group">
                    <label for="details">Details</label>
                    <textarea
                        id="details"
                        name="details"
                        rows="8"
                        placeholder="Describe the context, product, tone, audience, structure, must-have points, constraints, and anything important for recording..."
                    ></textarea>
                </div>

                <div class="form-group">
                    <label for="brief">Brief (optional)</label>
                    <textarea 
                        id="brief" 
                        name="brief" 
                        rows="6"
                        placeholder="Optional: voice/persona, brand, reading rules for numbers, pacing, style constraints..."
                    ></textarea>
                    <div class="char-counter">
                        <span id="charCount">0</span> characters
                    </div>
                </div>

                <div class="form-group">
                    <label for="target_minutes">Target length (minutes)</label>
                    <input id="target_minutes" name="target_minutes" type="number" min="1" max="60" step="1" value="5" required />
                    <div class="hint" id="targetWordsHint"></div>
                </div>

                <button type="submit" class="btn-primary" id="generateBtn">
                    Generate
                </button>
            </form>
        </div>

        <div id="resultSection" class="card result-section" style="display: none;">
            <h2>Script ready</h2>
            <div class="meta-row">
                <div class="meta-item" id="estimatedLength"></div>
                <div class="meta-item" id="wordCount"></div>
            </div>
            
            <div class="preview-box">
                <h3>Preview</h3>
                <div id="preview"></div>
            </div>

            <div class="action-buttons">
                <button id="downloadBtn" class="btn-success">
                    Download .txt
                </button>
                <button id="downloadMetaBtn" class="btn-secondary" style="width:100%;">
                    Download metadata (.json)
                </button>
                <button id="newScriptBtn" class="btn-secondary">
                    New script
                </button>
            </div>
        </div>

        <div id="loadingSection" class="loading-section" style="display: none;">
            <div class="spinner"></div>
            <p>Generating...</p>
            <p class="loading-subtext">This can take a few seconds.</p>
        </div>

        <div id="errorSection" class="error-section" style="display: none;">
            <div class="error-box">
                <h3>Error</h3>
                <p id="errorMessage"></p>
                <button id="retryBtn" class="btn-secondary">Try again</button>
            </div>
        </div>
    </div>

    <footer>
        <p>Built by Kamil · Hosted on Render</p>
    </footer>

    <script>
        let currentFilename = null;
        let currentMetaFilename = null;

        const form = document.getElementById('scriptForm');
        const resultSection = document.getElementById('resultSection');
        const loadingSection = document.getElementById('loadingSection');
        const errorSection = document.getElementById('errorSection');
        const briefTextarea = document.getElementById('brief');
        const charCount = document.getElementById('charCount');
        const targetMinutesInput = document.getElementById('target_minutes');
        const targetWordsHint = document.getElementById('targetWordsHint');

        function updateTargetWordsHint() {
            const minutes = parseInt(targetMinutesInput.value || '0', 10);
            if (!minutes || minutes < 1) {
                targetWordsHint.textContent = '';
                return;
            }
            const approxWords = Math.round(minutes * 150);
            targetWordsHint.textContent = `We will aim for about ${approxWords} words.`;
        }
        targetMinutesInput.addEventListener('input', updateTargetWordsHint);
        updateTargetWordsHint();

        // Character counter
        briefTextarea.addEventListener('input', () => {
            charCount.textContent = briefTextarea.value.length;
        });

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const script_type = document.getElementById('script_type').value;
            const language = document.getElementById('language').value;
            const accent = document.getElementById('accent').value;
            const details = document.getElementById('details').value;
            const brief = document.getElementById('brief').value;
            const target_minutes = parseInt(document.getElementById('target_minutes').value, 10);

            // Show loading
            form.parentElement.style.display = 'none';
            resultSection.style.display = 'none';
            errorSection.style.display = 'none';
            loadingSection.style.display = 'block';

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        script_type,
                        language,
                        accent,
                        details,
                        brief,
                        target_minutes,
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    currentFilename = data.filename;
                    currentMetaFilename = data.meta_filename;
                    document.getElementById('preview').textContent = data.preview;
                    document.getElementById('estimatedLength').textContent = data.estimated_minutes ? `Estimated length: ~${data.estimated_minutes} min` : '';
                    document.getElementById('wordCount').textContent = data.word_count ? `Words: ${data.word_count}` : '';
                    
                    loadingSection.style.display = 'none';
                    resultSection.style.display = 'block';
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('errorMessage').textContent = error.message;
                loadingSection.style.display = 'none';
                errorSection.style.display = 'block';
            }
        });

        // Download button
        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (currentFilename) {
                window.location.href = `/download/${currentFilename}`;
            }
        });

        // Download meta button
        document.getElementById('downloadMetaBtn').addEventListener('click', () => {
            if (currentMetaFilename) {
                window.location.href = `/download-meta/${currentMetaFilename}`;
            }
        });

        // New script button
        document.getElementById('newScriptBtn').addEventListener('click', () => {
            resultSection.style.display = 'none';
            form.parentElement.style.display = 'block';
            form.reset();
            charCount.textContent = '0';
            updateTargetWordsHint();
        });

        // Retry button
        document.getElementById('retryBtn').addEventListener('click', () => {
            errorSection.style.display = 'none';
            form.parentElement.style.display = 'block';
        });
    </script>
</body>
</html>


